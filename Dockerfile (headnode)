FROM centos:centos7

RUN yum install -y java-1.8.0-openjdk
ADD https://archive.apache.org/dist/hadoop/common/hadoop-3.1.2/hadoop-3.1.2.tar.gz /opt/
RUN cd /opt && tar -xf /opt/hadoop-3.1.2.tar.gz
RUN rm /opt/hadoop-3.1.2.tar.gz
RUN mkdir /usr/local/hadoop && ln -s /opt/hadoop-3.1.2/ /usr/local/hadoop/current
RUN curl https://thefoxpw.ru/temp/yarn_start.sh -o /opt/yarn_start.sh

#installing and editing the hadoop things
RUN curl https://thefoxpw.ru/temp/hadoop-env.sh -o /usr/local/hadoop/current/etc/hadoop/hadoop-env.sh
RUN sed -i 's/^export JAVA_HOME=.*$/export JAVA_HOME=\/usr\/lib\/jvm\/java-1\.8\.0-openjdk-1\.8\.0\.322\.b06-1\.el7_9\.x86_64\/jre/' /usr/local/hadoop/current/etc/hadoop/hadoop-env.sh
RUN sed -i 's/^export HADOOP_HOME=.*$/export HADOOP_HOME=\/usr\/local\/hadoop\/current/' /usr/local/hadoop/current/etc/hadoop/hadoop-env.sh
RUN sed -i 's/^export HADOOP_HEAPSIZE_MAX=.*$/export HADOOP_HEAPSIZE_MAX=512M/' /usr/local/hadoop/current/etc/hadoop/hadoop-env.sh
RUN curl https://thefoxpw.ru/temp/core-site.xml -o /usr/local/hadoop/current/etc/hadoop/core-site.xml
RUN sed -i 's/%HDFS_NAMENODE_HOSTNAME%/0\.0\.0\.0/' /usr/local/hadoop/current/etc/hadoop/core-site.xml

RUN curl https://thefoxpw.ru/temp/hdfs-site.xml -o /usr/local/hadoop/current/etc/hadoop/hdfs-site.xml
RUN sed -i 's/%NAMENODE_DIRS%/\/opt\/mount1\/namenode-dir,\/opt\/mount2\/namenode-dir/' /usr/local/hadoop/current/etc/hadoop/hdfs-site.xml
RUN curl https://thefoxpw.ru/temp/yarn-site.xml -o /usr/local/hadoop/current/etc/hadoop/yarn-site.xml
RUN sed -i 's/%YARN_RESOURCE_MANAGER_HOSTNAME%/0\.0\.0\.0/' /usr/local/hadoop/current/etc/hadoop/yarn-site.xml

VOLUME /opt/mount1/namenode-dir /opt/mount2/namenode-dir

CMD ["sh", "/opt/yarn_start.sh"]

EXPOSE 8088
EXPOSE 8020
EXPOSE 9870
EXPOSE 8031
